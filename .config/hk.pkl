amends "package://github.com/jdx/hk/releases/download/v1.25.0/hk@1.25.0#/Config.pkl"
import "package://github.com/jdx/hk/releases/download/v1.25.0/hk@1.25.0#/Builtins.pkl"

local linters = new Mapping<String, Step> {
    ["prettier"] {
        stage = "<JOB_FILES>"
        glob = List("**/*.md", "**/*.yaml", "**/*.json", "**/*.html")
        check = "mise run --force text:check {{ files }}"
        fix = "mise run --force text:fix {{ files }}"
    }
    ["shfmt"] = Builtins.shfmt
    ["shellcheck"] = Builtins.shellcheck
    ["pkl"] = Builtins.pkl
    ["taplo"] = (Builtins.taplo) {
        check = "mise run --force toml:check {{ files }}"
    }
    ["taplo-format"] = (Builtins.taplo) {
        check = "mise run --force toml:check-format {{ files }}"
        fix = "mise run --force toml:fix-format {{ files }}"
    }
    ["yamllint"] = (Builtins.yamllint) {
        check = "mise run --force yaml:check {{ files }}"
    }
    ["gomod-tidy"] = Builtins.gomod_tidy
    ["newlines"] = Builtins.newlines
    ["trailing-whitespace"] = Builtins.trailing_whitespace
    ["markdown-lint"] = (Builtins.markdown_lint) {
        check = "mise run --force markdown:check {{ files }}"
        fix = "mise run --force markdown:fix {{ files }}"
    }
}

hooks {
    ["pre-commit"] {
        fix = true
        stash = "git"
        steps {
            ...linters
            ["golangci-lint"] = (Builtins.golangci_lint) {
                check = "mise run golang:check --fast-only --new-from-rev HEAD"
                fix = "mise run golang:fix --fast-only --new-from-rev HEAD"
            }
        }
    }
    ["pre-push"] {
        steps {
            ...linters
            ["golangci-lint"] = (Builtins.golangci_lint) {
                check = "mise run golang:check --new-from-rev HEAD"
                fix = "mise run golang:fix --new-from-rev HEAD"
            }
            ["go:test"] {
                glob = List("**/*.go", "**/go.mod", "**/go.sum")
                check = "mise run golang:test"
            }
        }
    }
    // "fix" and "check" are special steps for `hk fix` and `hk check` commands
    ["fix"] {
        fix = true
        steps {
            ...linters
            ["golangci-lint"] = (Builtins.golangci_lint) {
                check = "mise run golang:check"
                fix = "mise run golang:fix"
            }
        }
    }
    ["check"] {
        steps {
            ...linters
            ["golangci-lint"] = (Builtins.golangci_lint) {
                check = "mise run golang:check"
                fix = "mise run golang:fix"
            }
        }
    }
}
